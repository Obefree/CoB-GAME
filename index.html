<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Duel Simulator</title>
  <link href="https://fonts.googleapis.com/css2?family=Germania+One&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS for modern UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Germania One', Arial, sans-serif; background: #f4f4f9; color: #222; margin: 0; padding: 0; }
    /* Custom container so Bootstrap's .container can be used */
    .sim-container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); padding: 32px 40px 40px 40px; }
    h1 { font-size: 2.2em; margin-bottom: 0.2em; text-align: center; }
    label, select, input, button { font-size: 1.1em; }
    .form-row { display: flex; gap: 24px; margin-bottom: 18px; align-items: center; }
    .form-row label { min-width: 120px; }
    .cards-list { max-height: 180px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fafbfc; margin-bottom: 18px; }
    .card-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .card-name { font-weight: bold; margin-right: 8px; }
    .card-effect { color: #555; font-size: 0.95em; }
    button { background: #222; color: #fff; border: none; border-radius: 6px; padding: 10px 28px; font-size: 1.2em; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #444; }
    /* Light hover animation for Bootstrap buttons */
    .btn { transition: transform 0.1s ease-in-out; }
    .btn:hover { transform: scale(1.05); }
    .results { margin-top: 32px; background: #f7f7fa; border-radius: 8px; padding: 18px 24px; font-size: 1.1em; }
    .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .stat-table th, .stat-table td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
    .stat-table th { background: #f0f0f0; }
    @media (max-width: 800px) { .sim-container { padding: 12px; } .form-row { flex-direction: column; gap: 8px; } }
  </style>
</head>
<body>
  <!-- Bootstrap container for centering with our custom style -->
  <div class="container sim-container mt-4">
    <h1>Card Duel Simulator</h1>
    <form id="sim-form">
      <div class="form-row">
        <label for="player1-strategy">–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1:</label>
        <select id="player1-strategy" name="player1-strategy"></select>
        <label for="hp1">HP 1:</label>
        <input type="number" id="hp1" name="hp1" value="40" min="1" max="99">
      </div>
      <div class="form-row">
        <label for="player2-strategy">–°—Ç—Ä–∞—Ç–µ–≥–∏—è 2:</label>
        <select id="player2-strategy" name="player2-strategy"></select>
        <label for="hp2">HP 2:</label>
        <input type="number" id="hp2" name="hp2" value="50" min="1" max="99">
      </div>
      <div class="form-row">
        <label for="num_games">–ö–æ–ª-–≤–æ –∏–≥—Ä:</label>
        <input type="number" id="num_games" name="num_games" value="1" min="1" max="100000">
      </div>
      <div class="form-row">
        <label>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∞:</label>
        <button type="button" id="open-log-config" class="btn btn-secondary ms-2">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥</button>
      </div>
      <div class="form-row">
        <label>–ö–∞—Ä—Ç—ã (–æ—Ç–∫–ª—é—á–∏—Ç—å/–≤–∫–ª—é—á–∏—Ç—å):</label>
      </div>
      <div class="cards-list" id="cards-list"></div>
      <button type="submit" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
    </form>
    <div class="results" id="results" style="display:none;"></div>
    <button id="show-detailed-log" class="btn btn-info mt-3" style="display:none;">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥</button>
    <div id="detailed-log-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:12px; padding:32px 24px; min-width:340px; max-width:90vw; max-height:90vh; overflow-y:auto; box-shadow:0 4px 32px rgba(0,0,0,0.18); position:relative;">
        <button id="close-detailed-log" type="button" style="position:absolute; top:12px; right:12px; font-size:2em; background:none; border:none; cursor:pointer; z-index:2100; color:#111;">√ó</button>
        <h2 style="margin-top:0;">–ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ –ø–∞—Ä—Ç–∏–∏ (–ø–æ—à–∞–≥–æ–≤–æ)</h2>
        <div id="detailed-log-content"></div>
      </div>
    </div>
    <button id="open-strategy-config" class="btn btn-secondary mt-4">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
    <div id="strategy-config-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:12px; padding:32px 24px; min-width:340px; max-width:90vw; max-height:90vh; overflow-y:auto; box-shadow:0 4px 32px rgba(0,0,0,0.18); position:relative;">
        <button id="close-strategy-config" type="button" style="position:absolute; top:12px; right:12px; font-size:2em; background:none; border:none; cursor:pointer; z-index:1100; color:#111;">√ó</button>
        <h2 style="margin-top:0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
        <div style="font-size:0.98em; color:#666; margin-bottom:8px;">–°–Ω—è—Ç–∞—è –≥–∞–ª–æ—á–∫–∞ ‚Äî –∫–∞—Ä—Ç–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å—Å—è –±–æ—Ç–æ–º.</div>
        <div style="margin-bottom:10px;">
          <label>–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:
            <select id="strategy-select" style="font-size:1em; margin-bottom:8px; min-width:160px;"></select>
          </label>
        </div>
        <label>–ò–º—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: <input id="strategy-name" style="font-size:1em; margin-bottom:12px;" maxlength="32"></label>
        <div id="strategy-cards-blocks"></div>
        <div style="margin-top:18px; background:#f3f6ff; border:1.5px solid #90caf9; border-radius:8px; padding:10px 14px 12px 14px;">
          <b>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –∑–æ–Ω–∞–º —Ö–æ–¥–æ–≤</b> <span title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –º—ã—à–∫–æ–π: —Å–ª–µ–≤–∞ ‚Äî —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç. –ë–æ—Ç –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –∫–∞—Ä—Ç—ã —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –≤ —ç—Ç–æ–º –ø–æ—Ä—è–¥–∫–µ. 'Priestess' ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞, –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.">üõà</span><br>
          <div style="margin-bottom:8px;">
            <b>1‚Äì4 —Ö–æ–¥:</b>
            <ul id="effect-priority-list-1" style="list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-wrap:wrap; gap:10px; min-height:36px;"></ul>
          </div>
          <div style="margin-bottom:8px;">
            <b>5‚Äì8 —Ö–æ–¥:</b>
            <ul id="effect-priority-list-2" style="list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-wrap:wrap; gap:10px; min-height:36px;"></ul>
          </div>
          <div style="margin-bottom:8px;">
            <b>9+ —Ö–æ–¥:</b>
            <ul id="effect-priority-list-3" style="list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-wrap:wrap; gap:10px; min-height:36px;"></ul>
          </div>
          <small style="color:#1976d2;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (—Å–ª–µ–≤–∞ ‚Äî —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π). 'Priestess' ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞, –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.</small>
        </div>
        <div style="margin-top:14px;">
          <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞—Ä—Ç—ã: <input type="number" id="max-cost" min="0" max="20" value="20" style="width:60px;"></label>
        </div>
        <div style="margin-top:10px;">
          <label><input type="checkbox" id="focus-trash"> –§–æ–∫—É—Å –Ω–∞ —Ç—Ä—ç—à (–∞–∫—Ç–∏–≤–Ω–æ –∏–∑–±–∞–≤–ª—è—Ç—å—Å—è –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç)</label>
        </div>
        <div style="margin-top:10px;">
          <label><input type="checkbox" id="focus-priestess"> –§–æ–∫—É—Å –Ω–∞ Priestess (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–∫—É–ø–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π —Å Priestess)</label>
        </div>
        <div style="margin-top:10px;">
          <label>–¢—Ä—ç—à–∏—Ç—å Priestess –ø–æ—Å–ª–µ <input type="number" id="priestess-trash-after" min="0" max="10" value="" style="width:40px;"> —Ä–∞–∑ (0 ‚Äî —Å—Ä–∞–∑—É, –ø—É—Å—Ç–æ ‚Äî –Ω–µ —Ç—Ä–µ—à–∏—Ç—å)</label>
        </div>
        <div style="margin-top:10px;">
          <label><input type="checkbox" id="priestess-buy-if-2"> –í—Å–µ–≥–¥–∞ –ø–æ–∫—É–ø–∞—Ç—å Priestess –∑–∞ 2, –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∫–∞—Ä—Ç</label>
        </div>
        <button id="save-strategy" type="button" class="btn btn-primary mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
        <h3 style="margin-top:28px;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h3>
        <ul id="saved-strategies-list" style="padding-left:18px;"></ul>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    async function loadStrategies() {
      const strategies = [
        {name: 'random'}
      ];
      const s1 = document.getElementById('player1-strategy');
      const s2 = document.getElementById('player2-strategy');
      strategies.forEach(s => {
        s1.innerHTML += `<option value="std:${s.name}">${s.name}</option>`;
        s2.innerHTML += `<option value="std:${s.name}">${s.name}</option>`;
      });
      s1.value = 'std:random';
      s2.value = 'std:random';
    }
    let allCards = [];
    let cardColors = [];
    let cardColorMap = {};
    let cardBlocks = {};
    let currentStrategy = null;
    let savedStrategies = {};
    let colorEffectsMap = {}; // {color: [—ç—Ñ—Ñ–µ–∫—Ç—ã]}

    async function loadCards() {
      const res = await fetch('/api/cards');
      const data = await res.json();
      const cards = [...data.main];
      allCards = cards;
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–≤–µ—Ç–∞–º
      cardColors = [...new Set(cards.map(c => c.color))].filter(Boolean);
      cardColorMap = {};
      colorEffectsMap = {};
      cardColors.forEach(color => {
        cardColorMap[color] = cards.filter(c => c.color === color).sort((a,b) => a.cost-b.cost);
        // –°–æ–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
        let effectsSet = new Set();
        cardColorMap[color].forEach(card => {
          [card.effect1, card.effect2, card.effect1text, card.effect2text].forEach(eff => {
            if (eff && eff.toLowerCase() !== 'none') {
              // –ü–∞—Ä—Å–∏–º —ç—Ñ—Ñ–µ–∫—Ç—ã –≤–∏–¥–∞ {Damage 3}{Draw 1}
              (eff.match(/\{([A-Za-z_]+)\s*[-\d]*\}/g)||[]).forEach(m => {
                let name = m.replace(/\{|\}|\s.*$/g,'');
                effectsSet.add(name.charAt(0).toUpperCase() + name.slice(1).toLowerCase());
              });
            }
          });
        });
        colorEffectsMap[color] = Array.from(effectsSet);
      });
      const list = document.getElementById('cards-list');
      list.innerHTML = '';
      cards.forEach(card => {
        const id = `card_${card.name.replace(/\W/g,'_')}`;
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π
        let effects = [];
        if (card.effect1 && card.effect1.toLowerCase() !== 'none') effects.push(card.effect1);
        if (card.effect2 && card.effect2.toLowerCase() !== 'none') effects.push(card.effect2);
        if (card.effect1text && card.effect1text.toLowerCase() !== 'none') effects.push(card.effect1text);
        if (card.effect2text && card.effect2text.toLowerCase() !== 'none') effects.push(card.effect2text);
        if (card.abilities) {
          for (const [k, v] of Object.entries(card.abilities)) {
            if (typeof v === 'string' && v && v.toLowerCase() !== 'none' && !effects.includes(v) && k.toLowerCase().includes('effect')) {
              effects.push(v);
            }
          }
        }
        const effectsStr = effects.join(' | ');
        list.innerHTML += `
          <div class="card-item">
            <input type="checkbox" id="${id}" checked>
            <span class="card-name">${card.name}</span>
            <span class="card-effect">[${card.color}] ${effectsStr}</span>
          </div>
        `;
      });
    }
    loadStrategies();
    loadCards();

    function updateStrategySelects() {
      const stdStrategies = [
        {name: 'random'}
      ];
      const select1 = document.getElementById('player1-strategy');
      const select2 = document.getElementById('player2-strategy');
      select1.innerHTML = '';
      select2.innerHTML = '';
      stdStrategies.forEach(s => {
        select1.innerHTML += `<option value="std:${s.name}">${s.name}</option>`;
        select2.innerHTML += `<option value="std:${s.name}">${s.name}</option>`;
      });
      Object.values(savedStrategies).forEach(strat => {
        select1.innerHTML += `<option value="user:${strat.name}">${strat.name}</option>`;
        select2.innerHTML += `<option value="user:${strat.name}">${strat.name}</option>`;
      });
      select1.value = 'std:random';
      select2.value = 'std:random';
    }
    function getSelectedStrategy(val) {
      if (!val) return null;
      if (val.startsWith('std:')) return {type: 'std', name: val.slice(4)};
      if (val.startsWith('user:')) return {type: 'user', name: val.slice(5)};
      return null;
    }
    document.getElementById('sim-form').onsubmit = async function(e) {
      e.preventDefault();
      const s1 = getSelectedStrategy(document.getElementById('player1-strategy').value);
      const s2 = getSelectedStrategy(document.getElementById('player2-strategy').value);
      const hp1 = +document.getElementById('hp1').value;
      const hp2 = +document.getElementById('hp2').value;
      const num_games = +document.getElementById('num_games').value;
      const cards = Array.from(document.querySelectorAll('.cards-list input[type=checkbox]'))
        .filter(cb => cb.checked)
        .map(cb => cb.parentElement.querySelector('.card-name').textContent);
      // logOptions —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –∏–∑ localStorage
      const logOptions = JSON.parse(localStorage.getItem('log_options')||'null') || [
        'debug','effects','buys','card_filter','hp','poison','bleed','hand','deck','discard','trash','market','player','error','all_effects'];
      let strategy1 = null, strategy2 = null;
      if (s1?.type === 'std') strategy1 = s1.name;
      if (s2?.type === 'std') strategy2 = s2.name;
      let user_strategy1 = null, user_strategy2 = null;
      if (s1?.type === 'user') user_strategy1 = savedStrategies[s1.name];
      if (s2?.type === 'user') user_strategy2 = savedStrategies[s2.name];
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').innerHTML = '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...';
      document.getElementById('show-detailed-log').style.display = 'none';
      document.getElementById('detailed-log-modal').style.display = 'none';
      const res = await fetch('/api/simulate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({strategy1, strategy2, user_strategy1, user_strategy2, hp1, hp2, num_games, enabled_cards: cards, log_options: logOptions})
      });
      const data = await res.json();
      // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ---
      if (data.result === 'error' || !data.stats) {
        let errMsg = '<b>–û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏!</b><br>';
        if (data.error) errMsg += `<pre>${data.error}</pre>`;
        if (data.traceback) errMsg += `<details><summary>Traceback</summary><pre>${data.traceback}</pre></details>`;
        document.getElementById('results').innerHTML = errMsg;
        return;
      }
      const stats = data.stats;
      let html = `<b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b><br>`;
      html += `<table class="stat-table">
        <tr><th>P1 win</th><td>${stats.P1_win}</td><th>P2 win</th><td>${stats.P2_win}</td></tr>
        <tr><th>–°—Ä–µ–¥–Ω–µ–µ —Ö–æ–¥–æ–≤</th><td>${stats.avg_turns}</td><th></th><td></td></tr>
        <tr><th>–ü–æ–±–µ–¥ —á–µ—Ä–µ–∑ —è–¥ (P1)</th><td>${stats.poison_win1 ?? '-'}</td><th>–ü–æ–±–µ–¥ —á–µ—Ä–µ–∑ —è–¥ (P2)</th><td>${stats.poison_win2 ?? '-'}</td></tr>
        <tr><th>–°—Ä–µ–¥–Ω–µ–µ HP1</th><td>${stats.avg_hp1}</td><th>–°—Ä–µ–¥–Ω–µ–µ HP2</th><td>${stats.avg_hp2}</td></tr>
        <tr><th>–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–Ω P1‚ÜíP2</th><td>${stats.avg_damage1 ?? '-'}</td><th>–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–Ω P2‚ÜíP1</th><td>${stats.avg_damage2 ?? '-'}</td></tr>
        <tr><th>Gear (—Å—Ä–µ–¥–Ω–µ–µ, P1)</th><td>${stats.gear_saved_damage_avg ? stats.gear_saved_damage_avg[0] : '-'}</td><th>Gear (—Å—Ä–µ–¥–Ω–µ–µ, P2)</th><td>${stats.gear_saved_damage_avg ? stats.gear_saved_damage_avg[1] : '-'}</td></tr>
        <tr><th>Gear (—Å—É–º–º–∞—Ä–Ω–æ, P1)</th><td>${stats.gear_saved_damage_total ? stats.gear_saved_damage_total[0] : '-'}</td><th>Gear (—Å—É–º–º–∞—Ä–Ω–æ, P2)</th><td>${stats.gear_saved_damage_total ? stats.gear_saved_damage_total[1] : '-'}</td></tr>
        <tr><th colspan="4">--- –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –ø–∞—Ä—Ç–∏—é ---</th></tr>
        <tr><th>–£—Ä–æ–Ω –Ω–∞–Ω–µ—Å—ë–Ω (P1)</th><td>${stats.avg_damage_dealt1}</td><th>–£—Ä–æ–Ω –Ω–∞–Ω–µ—Å—ë–Ω (P2)</th><td>${stats.avg_damage_dealt2}</td></tr>
        <tr><th>–Ø–¥ –Ω–∞–Ω–µ—Å—ë–Ω (P1)</th><td>${stats.avg_poison_dealt1}</td><th>–Ø–¥ –Ω–∞–Ω–µ—Å—ë–Ω (P2)</th><td>${stats.avg_poison_dealt2}</td></tr>
        <tr><th>Bleed –Ω–∞–Ω–µ—Å—ë–Ω (P1)</th><td>${stats.avg_bleed_dealt1}</td><th>Bleed –Ω–∞–Ω–µ—Å—ë–Ω (P2)</th><td>${stats.avg_bleed_dealt2}</td></tr>
        <tr><th>–õ–µ—á–µ–Ω–∏–µ HP (P1)</th><td>${stats.avg_heal_received1}</td><th>–õ–µ—á–µ–Ω–∏–µ HP (P2)</th><td>${stats.avg_heal_received2}</td></tr>
        <tr><th>–õ–µ—á–µ–Ω–∏–µ —è–¥–∞ (P1)</th><td>${stats.avg_poison_heal_received1}</td><th>–õ–µ—á–µ–Ω–∏–µ —è–¥–∞ (P2)</th><td>${stats.avg_poison_heal_received2}</td></tr>
        <tr><th>–õ–µ—á–µ–Ω–∏–µ bleed (P1)</th><td>${stats.avg_bleed_heal_received1}</td><th>–õ–µ—á–µ–Ω–∏–µ bleed (P2)</th><td>${stats.avg_bleed_heal_received2}</td></tr>
        <tr><th>–¢—Ä—ç—à (P1, trash)</th><td>${stats.avg_trash1}</td><th>–¢—Ä—ç—à (P2, trash)</th><td>${stats.avg_trash2}</td></tr>
        <tr><th>–¢—Ä—ç—à (P1, trash_this)</th><td>${stats.avg_trash_this1}</td><th>–¢—Ä—ç—à (P2, trash_this)</th><td>${stats.avg_trash_this2}</td></tr>
      </table>`;
      html += `<b>–¢—Ä—ç—à (—Ç–æ–ø):</b><br><ul>`;
      stats.trashed_cards.forEach(([name, count]) => {
        html += `<li>${name}: ${count}</li>`;
      });
      html += `</ul>`;
      html += `<b>–¢–æ–ø –∫–∞—Ä—Ç –ø–æ value:</b><br><ul>`;
      stats.top_cards.forEach(([name, count]) => {
        html += `<li>${name}: ${count}</li>`;
      });
      html += `</ul>`;
      html += `<b>Gear (–ø–æ–≥–ª–æ—â—ë–Ω–Ω—ã–π —É—Ä–æ–Ω):</b><br><ul>`;
      stats.gear_absorbed.forEach(([name, val]) => {
        html += `<li>${name}: ${val}</li>`;
      });
      html += `</ul>`;
      // --- –ù–æ–≤—ã–π –±–ª–æ–∫: —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ ---
      if (data.player1 && data.player2) {
        html += `<h3>–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</h3>`;
        [1,2].forEach(num => {
          const p = data[`player${num}`];
          html += `<b>P${num}:</b><br>`;
          html += `–†—É–∫–∞: [${(p.hand||[]).map(c=>c.name).join(', ')}]<br>`;
          html += `–ö–æ–ª–æ–¥–∞: [${(p.deck||[]).map(c=>c.name).join(', ')}]<br>`;
          html += `–°–±—Ä–æ—Å: [${(p.discard||[]).map(c=>c.name).join(', ')}]<br>`;
          html += `Gear: [${(p.gear||[]).map(c=>c.name).join(', ')}]<br>`;
          html += `–¢—Ä—ç—à: [${(p.trash_pile||[]).map(c=>c.name).join(', ')}]<br>`;
        });
      }
      // --- –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–Æ: –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ –ø–æ —Ö–æ–¥–∞–º (detailed_log) ---
      if (data.detailed_log && Array.isArray(data.detailed_log)) {
        document.getElementById('show-detailed-log').style.display = 'inline-block';
        document.getElementById('show-detailed-log').onclick = function() {
          let logHtml = '';
          logHtml += `<div id="detailed-log-block">`;
          data.detailed_log.forEach(turn => {
            logHtml += `<details style='margin-bottom:8px;'><summary><b>–•–æ–¥ ${turn.turn}</b></summary>`;
            (turn.actions || []).forEach(action => {
              if (action.lost) {
                logHtml += `<div style='color:#b00; margin-left:12px;'><b>${action.player} –ø—Ä–æ–∏–≥—Ä–∞–ª!</b></div>`;
                return;
              }
              if (action.start_status) {
                let blessingInfo = action.total_blessing ? `, Blessing=${action.total_blessing}` : '';
                logHtml += `<div style='margin-left:12px;'><b>${action.player} (–Ω–∞—á–∞–ª–æ):</b> HP=${action.start_status.hp}, Poison=${action.start_status.poison}, Bleed=${action.start_status.bleed}${blessingInfo}, Hand=[${action.start_status.hand.join(', ')}], Gear=[${action.start_status.gear.join(', ')}]</div>`;
              }
              // --- –†—ã–Ω–æ–∫ –∏ –ø–æ–∫—É–ø–∫–∏ —Å —Ü–≤–µ—Ç–∞–º–∏ ---
              if (action.market_states && action.market_states.length) {
                logHtml += `<div style='margin-left:18px;'><b>–†—ã–Ω–æ–∫ –∏ –ø–æ–∫—É–ø–∫–∏:</b><ul style='margin:0 0 0 16px;'>`;
                action.market_states.forEach((step, idx) => {
                  let marketList = (step.market||[]).map(c => {
                    let color = c.color ? c.color.toLowerCase() : '';
                    let colorStyle = color ? `background:#${colorToHex(color)};color:#222; border-radius:4px; padding:1px 6px; margin-right:2px;` : '';
                    return `<span style='${colorStyle}'>${c.name} (${c.cost})${c.is_gear ? ' üõ°Ô∏è' : ''}${c.copies>1?` x${c.copies}`:''}</span>`;
                  }).join(' ');
                  logHtml += `<li>–ü–æ–∫—É–ø–∫–∞: <b>${step.buy}</b> | –†—ã–Ω–æ–∫: ${marketList}</li>`;
                });
                logHtml += `</ul></div>`;
              }
              // --- –°—ã–≥—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã ---
              if (action.played && action.played.length) {
                let playedNames = action.played.map(card => {
                  let color = card.color ? card.color.toLowerCase() : '';
                  let colorStyle = color ? `background:#${colorToHex(color)};color:#222; border-radius:4px; padding:1px 6px; margin-right:2px;` : '';
                  return `<span style='${colorStyle}'>${card.name}</span>`;
                });
                logHtml += `<div style='margin-left:18px;'>–†–∞–∑—ã–≥—Ä–∞–Ω–æ: ${playedNames.join(', ')}</div>`;
              }
              // --- –≠—Ñ—Ñ–µ–∫—Ç—ã ---
              if (action.effects && action.effects.length) {
                logHtml += `<div style='margin-left:18px;'>–≠—Ñ—Ñ–µ–∫—Ç—ã:<ul style='margin:0 0 0 16px;'>`;
                action.effects.forEach(eff => {
                  logHtml += `<li>${eff.card}: ${eff.effect} (${eff.value}) ‚Üí ${eff.target}</li>`;
                });
                logHtml += `</ul></div>`;
              }
              // --- –ü–æ–∫—É–ø–∫–∏ ---
              if (action.bought && action.bought.length) {
                logHtml += `<div style='margin-left:18px;'>–ü–æ–∫—É–ø–∫–∏: ${action.bought.join(', ')}</div>`;
              }
              // --- –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ ---
              if (action.end_status) {
                let s = action.end_status;
                function renderCardList(arr, label) {
                  if (!arr || !arr.length) return `${label}: [ ]`;
                  return `${label}: [` + arr.map(name => {
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ü–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏ –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å allCards)
                    let card = (window.allCards||[]).find(c => c.name === name);
                    let color = card && card.color ? card.color.toLowerCase() : '';
                    let colorStyle = color ? `background:#${colorToHex(color)};color:#222; border-radius:4px; padding:1px 6px; margin-right:2px;` : '';
                    return `<span style='${colorStyle}'>${name}</span>`;
                  }).join(' ') + ']';
                }
                logHtml += `<div style='margin-left:12px; color:#080;'><b>${action.player} (–∫–æ–Ω–µ—Ü):</b> HP=${s.hp}, Poison=${s.poison}, Bleed=${s.bleed}`;
                logHtml += `<br>${renderCardList(s.hand_cards, '–†—É–∫–∞')}`;
                logHtml += `<br>${renderCardList(s.deck_cards, '–ö–æ–ª–æ–¥–∞')}`;
                logHtml += `<br>${renderCardList(s.discard_cards, '–°–±—Ä–æ—Å')}`;
                logHtml += `<br>${renderCardList(s.trash_cards, '–¢—Ä—ç—à')}`;
                logHtml += `</div>`;
              }
            });
            logHtml += `</details>`;
          });
          logHtml += `</div>`;
          document.getElementById('detailed-log-content').innerHTML = logHtml;
          document.getElementById('detailed-log-modal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
        };
        document.getElementById('close-detailed-log').onclick = function() {
          document.getElementById('detailed-log-modal').style.display = 'none';
          document.body.style.overflow = '';
        };
      } else {
        document.getElementById('show-detailed-log').style.display = 'none';
      }
      document.getElementById('results').innerHTML = html;
    };

    // --- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ ---
    // --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ---
    function renderStrategyBlocks(strategy=null) {
      const container = document.getElementById('strategy-cards-blocks');
      container.innerHTML = '';
      cardBlocks = {};
      cardColors.forEach(color => {
        const block = document.createElement('div');
        block.style.border = '2px solid #'+(colorToHex(color));
        block.style.borderRadius = '8px';
        block.style.marginBottom = '18px';
        block.style.padding = '10px 12px 12px 12px';
        block.style.background = '#f9f9fc';
        block.innerHTML = `<b style="color:#${colorToHex(color)}; font-size:1.1em;">${color}</b>`;
        // –ö–Ω–æ–ø–∫–∏ –≤—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å –≤—Å–µ
        const btns = document.createElement('div');
        btns.style.margin = '6px 0 8px 0';
        btns.innerHTML = `<button type="button" class="select-all" data-color="${color}">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button> <button type="button" class="deselect-all" data-color="${color}">–°–Ω—è—Ç—å –≤—Å–µ</button>`;
        block.appendChild(btns);
        // --- –ë–ª–æ–∫: —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º ---
        const effectFilterDiv = document.createElement('div');
        effectFilterDiv.style.margin = '8px 0 8px 0';
        effectFilterDiv.innerHTML = '<b>–§–∏–ª—å—Ç—Ä –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º:</b> ';
        let colorEffs = colorEffectsMap[color] || [];
        if (colorEffs.length === 0) colorEffs = ['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage'];
        let checkedEffs = (strategy && strategy.effect_filters && strategy.effect_filters[color]) ? strategy.effect_filters[color].slice() : colorEffs.slice();
        if (!checkedEffs.length) checkedEffs = colorEffs.slice();
        colorEffs.forEach(eff => {
          const id = `filter_${color}_${eff}`;
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = id;
          cb.checked = checkedEffs.includes(eff);
          cb.onchange = () => {
            let prevEnabled = {};
            if (cardBlocks[color]) {
              Array.from(cardBlocks[color].children).forEach(li => {
                const name = li.querySelector('.card-name').textContent;
                const checked = li.querySelector('input[type=checkbox]').checked;
                prevEnabled[name] = checked;
              });
            }
            renderCardListForColor(color, block, strategy, prevEnabled);
          };
          effectFilterDiv.appendChild(cb);
          const lbl = document.createElement('label');
          lbl.htmlFor = id;
          lbl.textContent = displayEffectName(eff); // –∫—Ä–∞—Å–∏–≤–æ!
          lbl.style.marginRight = '8px';
          effectFilterDiv.appendChild(lbl);
        });
        block.appendChild(effectFilterDiv);
        // --- –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç ---
        renderCardListForColor(color, block, strategy);
        // --- –Ø–≤–Ω–æ –¥–µ–ª–∞–µ–º –±–ª–æ–∫ –≤–∏–¥–∏–º—ã–º ---
        block.style.display = '';
        container.appendChild(block);
      });
      // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å –≤—Å–µ
      setTimeout(()=>{
        document.querySelectorAll('.select-all').forEach(btn=>{
          btn.onclick = ()=>{
            const color = btn.getAttribute('data-color');
            Array.from(cardBlocks[color].children).forEach(li=>{
              li.querySelector('input[type=checkbox]').checked = true;
              li.querySelector('.card-name').style.color = '';
              li.querySelector('.card-name').style.textDecoration = '';
            });
          };
        });
        document.querySelectorAll('.deselect-all').forEach(btn=>{
          btn.onclick = ()=>{
            const color = btn.getAttribute('data-color');
            Array.from(cardBlocks[color].children).forEach(li=>{
              li.querySelector('input[type=checkbox]').checked = false;
              li.querySelector('.card-name').style.color = '#bbb';
              li.querySelector('.card-name').style.textDecoration = 'line-through';
            });
          };
        });
        document.querySelectorAll('.strategy-card-checkbox').forEach(cb=>{
          cb.onchange = ()=>{
            const nameSpan = cb.parentElement.querySelector('.card-name');
            if(cb.checked){
              nameSpan.style.color = '';
              nameSpan.style.textDecoration = '';
            } else {
              nameSpan.style.color = '#bbb';
              nameSpan.style.textDecoration = 'line-through';
            }
          };
        });
      }, 100);
      document.getElementById('focus-trash').checked = !!strategy?.focus_trash;
      document.getElementById('focus-priestess').checked = !!strategy?.focus_priestess;
      document.getElementById('priestess-trash-after').value = strategy?.priestess_trash_after ?? '';
      document.getElementById('priestess-buy-if-2').checked = !!strategy?.priestess_buy_if_2;
    }
    function colorToHex(color) {
      // –ü—Ä–∏–º–∏—Ç–∏–≤–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Å hex (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
      const map = {red:'e57373', blue:'64b5f6', green:'81c784', white:'fff176', black:'757575', yellow:'ffd54f', purple:'ba68c8', orange:'ffb74d'};
      return map[color.toLowerCase()]||'bdbdbd';
    }
    const EFFECTS = ['Draw', 'Heal', 'Poison', 'Bleed', 'Trash', 'Gear', 'Spy', 'Stun', 'Blessing', 'Damage'];
    function renderEffectPriorityList(strategy=null) {
      const ul = document.getElementById('effect-priority-list');
      ul.innerHTML = '';
      let effects = EFFECTS.slice();
      if (strategy && strategy.effect_priority) {
        effects = strategy.effect_priority.concat(effects.filter(e=>!strategy.effect_priority.includes(e)));
      }
      effects.forEach(eff => {
        const li = document.createElement('li');
        li.textContent = eff;
        li.style.background = '#eee';
        li.style.padding = '4px 10px';
        li.style.borderRadius = '6px';
        li.style.cursor = 'grab';
        li.style.userSelect = 'none';
        ul.appendChild(li);
      });
      Sortable.create(ul, {animation: 150});
    }
    // --- –ù–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –∑–æ–Ω–∞–º ---
    function renderEffectPriorityLists(strategy=null) {
      const EFFECTS = ['Draw', 'Heal', 'Poison', 'Bleed', 'Trash', 'Gear', 'Spy', 'Stun', 'Blessing', 'Damage', 'Priestess'];
      [1,2,3].forEach(zone => {
        const ul = document.getElementById(`effect-priority-list-${zone}`);
        ul.innerHTML = '';
        let effects = [];
        if (strategy && strategy.effect_priority && strategy.effect_priority[zone] && strategy.effect_priority[zone].length) {
          // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Draw')
          const seen = new Set();
          strategy.effect_priority[zone].forEach(eff => {
            const norm = eff.charAt(0).toUpperCase() + eff.slice(1).toLowerCase();
            if (!seen.has(norm)) {
              effects.push(norm);
              seen.add(norm);
            }
          });
          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç
          EFFECTS.forEach(eff => {
            if (!seen.has(eff)) {
              effects.push(eff);
              seen.add(eff);
            }
          });
        } else {
          effects = EFFECTS.slice();
        }
        effects.forEach(eff => {
          const li = document.createElement('li');
          li.textContent = eff;
          if (eff.toLowerCase() === 'priestess') {
            li.style.background = '#eee';
            li.style.color = '#888';
            li.style.fontWeight = 'bold';
            li.style.border = '1.5px solid #888';
          } else {
            li.style.background = '#eee';
            li.style.color = '#222';
          }
          li.style.padding = '4px 10px';
          li.style.borderRadius = '6px';
          li.style.cursor = 'grab';
          li.style.userSelect = 'none';
          ul.appendChild(li);
        });
        Sortable.create(ul, {
          animation: 150,
          onEnd: function() {
            let newOrder = Array.from(ul.children).map(li=>li.textContent);
            console.log(`Zone ${zone} new priority:`, newOrder);
          }
        });
      });
    }
    // --- –ù–æ–≤—ã–π UI: —Ç–æ–ª—å–∫–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º ---
    function renderGlobalEffectFilters(strategy=null) {
      const container = document.getElementById('strategy-cards-blocks');
      container.innerHTML = '';
      // –ë–æ–ª—å—à–µ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º
    }
    // --- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é renderStrategyBlocks –¥–ª—è –Ω–æ–≤–æ–≥–æ UI ---
    function renderStrategyBlocks(strategy=null) {
      // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º
      document.getElementById('focus-trash').checked = !!strategy?.focus_trash;
      document.getElementById('focus-priestess').checked = !!strategy?.focus_priestess;
      document.getElementById('priestess-trash-after').value = strategy?.priestess_trash_after ?? '';
      document.getElementById('priestess-buy-if-2').checked = !!strategy?.priestess_buy_if_2;
    }
    function getStrategyFromUI() {
      const name = document.getElementById('strategy-name').value.trim()||'–ë–µ–∑ –∏–º–µ–Ω–∏';
      // --- –ù–æ–≤—ã–π —Å–±–æ—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º ---
      const effect_filters = {};
      effect_filters['global'] = [];
      const EFFECTS = ['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage','Priestess'];
      EFFECTS.forEach(eff => {
        const id = `filter_global_${eff}`;
        const cb = document.getElementById(id);
        if (cb && cb.checked) effect_filters['global'].push(eff.toLowerCase());
      });
      // --- –ù–æ–≤—ã–π —Å–±–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –ø–æ –∑–æ–Ω–∞–º ---
      const effect_priority = {};
      [1,2,3].forEach(zone => {
        effect_priority[zone] = Array.from(document.querySelectorAll(`#effect-priority-list-${zone} li`)).map(li=>li.textContent.toLowerCase());
      });
      const max_cost = +document.getElementById('max-cost').value;
      const focus_trash = document.getElementById('focus-trash').checked;
      const focus_priestess = document.getElementById('focus-priestess').checked;
      const priestess_trash_after = document.getElementById('priestess-trash-after').value ? +document.getElementById('priestess-trash-after').value : null;
      const priestess_buy_if_2 = document.getElementById('priestess-buy-if-2').checked;
      return {name, effect_filters, effect_priority, max_cost, focus_trash, focus_priestess, priestess_trash_after, priestess_buy_if_2};
    }
    function saveStrategy() {
      const strat = getStrategyFromUI();
      savedStrategies[strat.name] = strat;
      localStorage.setItem('saved_strategies', JSON.stringify(savedStrategies));
      renderSavedStrategies();
    }
    function renderSavedStrategies() {
      const ul = document.getElementById('saved-strategies-list');
      ul.innerHTML = '';
      Object.values(savedStrategies).forEach(strat => {
        const li = document.createElement('li');
        li.style.marginBottom = '6px';
        li.innerHTML = `<b>${strat.name}</b> <button data-name="${strat.name}" class="choose-strategy">–í—ã–±—Ä–∞—Ç—å</button> <button data-name="${strat.name}" class="delete-strategy">–£–¥–∞–ª–∏—Ç—å</button>`;
        ul.appendChild(li);
      });
      // –ö–Ω–æ–ø–∫–∏
      ul.querySelectorAll('.choose-strategy').forEach(btn => {
        btn.onclick = e => {
          const strat = savedStrategies[btn.getAttribute('data-name')];
          if (strat) {
            document.getElementById('strategy-name').value = strat.name;
            renderStrategyBlocks(strat);
            renderEffectPriorityLists(strat); // Updated call
            currentStrategy = strat;
          }
        };
      });
      ul.querySelectorAll('.delete-strategy').forEach(btn => {
        btn.onclick = e => {
          const name = btn.getAttribute('data-name');
          delete savedStrategies[name];
          localStorage.setItem('saved_strategies', JSON.stringify(savedStrategies));
          renderSavedStrategies();
        };
      });
    }
    function updateUserStrategySelects() {
      const select1 = document.getElementById('user-strategy1');
      const select2 = document.getElementById('user-strategy2');
      select1.innerHTML = '<option value="">(–Ω–µ –≤—ã–±—Ä–∞–Ω–∞)</option>';
      select2.innerHTML = '<option value="">(–Ω–µ –≤—ã–±—Ä–∞–Ω–∞)</option>';
      Object.values(savedStrategies).forEach(strat => {
        select1.innerHTML += `<option value="${strat.name}">${strat.name}</option>`;
        select2.innerHTML += `<option value="${strat.name}">${strat.name}</option>`;
      });
    }
    function getUserStrategyObj(stratName) {
      if (!stratName || !savedStrategies[stratName]) return null;
      return savedStrategies[stratName];
    }
    // --- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π ---
    function updateStrategyDropdown() {
      const select = document.getElementById('strategy-select');
      select.innerHTML = '';
      select.innerHTML += `<option value="">(–ù–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)</option>`;
      Object.values(savedStrategies).forEach(strat => {
        select.innerHTML += `<option value="${strat.name}">${strat.name}</option>`;
      });
      select.value = currentStrategy?.name || '';
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ ---
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('open-strategy-config').onclick = ()=>{
        document.getElementById('strategy-config-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        document.getElementById('strategy-name').value = currentStrategy?.name||'';
        // –§–æ—Ä—Å–∏—Ä—É–µ–º —Ä–µ–Ω–¥–µ—Ä –±–ª–æ–∫–æ–≤ –∫–∞—Ä—Ç –¥–∞–∂–µ –µ—Å–ª–∏ currentStrategy=null
        renderStrategyBlocks(currentStrategy||null);
        renderEffectPriorityLists(currentStrategy||null); // Updated call
        renderSavedStrategies();
        updateStrategyDropdown();
      };
      document.getElementById('close-strategy-config').onclick = ()=>{
        document.getElementById('strategy-config-modal').style.display = 'none';
        document.body.style.overflow = '';
      };
      document.getElementById('save-strategy').onclick = ()=>{
        saveStrategy();
        alert('–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
        updateStrategySelects();
      };
      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
      try {
        savedStrategies = JSON.parse(localStorage.getItem('saved_strategies')||'{}');
      } catch(e) { savedStrategies = {}; }
      if (Object.keys(savedStrategies).length) {
        currentStrategy = Object.values(savedStrategies)[0];
      }
      updateStrategySelects();
      setTimeout(()=>{
        updateStrategyDropdown();
        document.getElementById('strategy-select').onchange = function() {
          const name = this.value;
          if (name && savedStrategies[name]) {
            document.getElementById('strategy-name').value = name;
            renderStrategyBlocks(savedStrategies[name]);
            renderEffectPriorityLists(savedStrategies[name]); // Updated call
            currentStrategy = savedStrategies[name];
          } else {
            document.getElementById('strategy-name').value = '';
            renderStrategyBlocks(null);
            renderEffectPriorityLists(null); // Updated call
            currentStrategy = null;
          }
        };
      }, 200);
    });

    // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∏–∑ —Å—Ç—Ä–æ–∫–∏ ---
    function parseEffectsFromString(str) {
      if (!str) return [];
      // –ò—â–µ–º {EffectName ...}
      return (str.match(/\{([A-Za-z_]+)\s*[-\d]*\}/g)||[]).map(m => {
        let name = m.replace(/\{|\}|\s.*$/g,'');
        return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
      });
    }
    // --- –î–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ ---
    function displayEffectName(eff) {
      // 'heal_bleed' -> 'Heal Bleed'
      return eff.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }
    // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ä—Ç –ø–æ —Ü–≤–µ—Ç—É —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ ---
    function renderCardListForColor(color, block, strategy, prevEnabled={}) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π ul, –µ—Å–ª–∏ –µ—Å—Ç—å
      let oldUl = block.querySelector('ul');
      if (oldUl) oldUl.remove();
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      ul.style.margin = '8px 0 0 0';
      ul.id = `block_${color}`;
      let cards = cardColorMap[color];
      // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
      let colorEffs = colorEffectsMap[color] || [];
      if (colorEffs.length === 0) colorEffs = ['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage'];
      let checkedEffs = colorEffs.filter(eff => {
        const cb = document.getElementById(`filter_${color}_${eff}`);
        return cb && cb.checked;
      });
      // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ä—Ç—ã: —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç—Ñ—Ñ–µ–∫—Ç –∏–∑ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö
      cards = cards.filter(card => {
        let effects = [];
        [card.effect1, card.effect2, card.effect1text, card.effect2text].forEach(eff => {
          effects = effects.concat(parseEffectsFromString(eff));
        });
        return effects.some(eff => checkedEffs.includes(eff));
      });
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏ enabled –∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–ª–∏ prevEnabled
      let stratArr = (strategy && strategy.cards && strategy.cards[color]) ? strategy.cards[color] : null;
      if (stratArr) {
        cards = stratArr.map(obj => {
          return allCards.find(c => c.name === obj.name) || obj;
        }).filter(c => cards.find(x=>x.name===c.name));
      }
      cards.forEach(card => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        li.setAttribute('data-card', card.name);
        // --- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º enabled –∏–∑ prevEnabled, –∏–Ω–∞—á–µ –∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –∏–Ω–∞—á–µ true ---
        let enabled = true;
        if (prevEnabled.hasOwnProperty(card.name)) {
          enabled = prevEnabled[card.name];
        } else if (stratArr) {
          const found = stratArr.find(obj=>obj.name===card.name);
          if (found) enabled = found.enabled !== false;
        }
        li.innerHTML = `
          <input type="checkbox" class="strategy-card-checkbox" ${enabled?'checked':''}>
          <span class="card-name" style="${enabled?'':'color:#bbb;text-decoration:line-through;'}">${card.name}</span>
          <span style="color:#555; font-size:0.95em;">(cost ${card.cost})</span>
          <span style="color:#888; font-size:0.9em;">${card.effect1} ${card.effect2}</span>
        `;
        ul.appendChild(li);
      });
      block.appendChild(ul);
      Sortable.create(ul, {animation: 150});
      cardBlocks[color] = ul;
    }
    // --- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –µ—Å–ª–∏ –Ω–µ—Ç effect_filters –∏–ª–∏ effect_priority, –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ—Ñ–æ–ª—Ç ---
    function loadStrategyDefaultsIfNeeded(strat) {
      let changed = false;
      if (!strat.effect_filters) {
        strat.effect_filters = {};
        cardColors.forEach(color => {
          strat.effect_filters[color] = (colorEffectsMap[color] && colorEffectsMap[color].length) ? colorEffectsMap[color].slice() : ['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage'];
        });
        strat.effect_filters['global'] = ['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage','Priestess'];
        changed = true;
      }
      if (!strat.effect_priority) {
        strat.effect_priority = {1:['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage','Priestess'],2:['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage','Priestess'],3:['Draw','Heal','Poison','Bleed','Trash','Gear','Spy','Stun','Blessing','Damage','Priestess']};
        changed = true;
      }
      return changed;
    }
    // --- –í–µ–∑–¥–µ, –≥–¥–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –≤—ã–∑—ã–≤–∞—Ç—å loadStrategyDefaultsIfNeeded ---
    // –í renderSavedStrategies, updateStrategyDropdown, –≤—ã–±–æ—Ä–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Ç.–¥.

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞–º–∏ –ª–æ–≥–æ–≤ ---
    document.addEventListener('DOMContentLoaded', function() {
      const logOptionsDiv = document.getElementById('log-options');
      if (logOptionsDiv) {
        const selectAllBtn = document.getElementById('log-select-all');
        const deselectAllBtn = document.getElementById('log-deselect-all');
        selectAllBtn.onclick = function() {
          logOptionsDiv.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
        };
        deselectAllBtn.onclick = function() {
          logOptionsDiv.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
        };
      }
    });

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ–≤ ---
    document.addEventListener('DOMContentLoaded', function() {
      const openLogBtn = document.getElementById('open-log-config');
      const logModal = document.getElementById('log-config-modal');
      const closeLogBtn = document.getElementById('close-log-config');
      const saveLogBtn = document.getElementById('save-log-config');
      const logOptionsModal = document.getElementById('log-options-modal');
      const selectAllBtn = document.getElementById('log-modal-select-all');
      const deselectAllBtn = document.getElementById('log-modal-deselect-all');
      let selectedLogOptions = JSON.parse(localStorage.getItem('log_options')||'null') || [
        'debug','effects','buys','card_filter','hp','poison','bleed','hand','deck','discard','trash','market','player','error','all_effects']
      function updateModalCheckboxes() {
        logOptionsModal.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.checked = selectedLogOptions.includes(cb.value);
        });
      }
      if (openLogBtn) openLogBtn.onclick = function() {
        updateModalCheckboxes();
        logModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      };
      if (closeLogBtn) closeLogBtn.onclick = function() {
        logModal.style.display = 'none';
        document.body.style.overflow = '';
      };
      if (selectAllBtn) selectAllBtn.onclick = function() {
        logOptionsModal.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
      };
      if (deselectAllBtn) deselectAllBtn.onclick = function() {
        logOptionsModal.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
      };
      if (saveLogBtn) saveLogBtn.onclick = function() {
        selectedLogOptions = Array.from(logOptionsModal.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
        localStorage.setItem('log_options', JSON.stringify(selectedLogOptions));
        logModal.style.display = 'none';
        document.body.style.overflow = '';
      };
    });
  </script>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ–≤ -->
  <div id="log-config-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:1500; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; padding:32px 24px; min-width:340px; max-width:90vw; max-height:90vh; overflow-y:auto; box-shadow:0 4px 32px rgba(0,0,0,0.18); position:relative;">
      <button id="close-log-config" type="button" style="position:absolute; top:12px; right:12px; font-size:2em; background:none; border:none; cursor:pointer; z-index:1600; color:#111;">√ó</button>
      <h2 style="margin-top:0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤</h2>
      <div id="log-options-modal" style="margin-bottom:18px;">
        <label><input type="checkbox" value="debug"> DEBUG</label><br>
        <label><input type="checkbox" value="effects"> –≠—Ñ—Ñ–µ–∫—Ç—ã –∑–∞ —Ö–æ–¥</label><br>
        <label><input type="checkbox" value="buys"> –ü–æ–∫—É–ø–∫–∏</label><br>
        <label><input type="checkbox" value="card_filter"> –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç/—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</label><br>
        <label><input type="checkbox" value="hp"> HP</label><br>
        <label><input type="checkbox" value="poison"> Poison</label><br>
        <label><input type="checkbox" value="bleed"> Bleed</label><br>
        <label><input type="checkbox" value="hand"> –†—É–∫–∞</label><br>
        <label><input type="checkbox" value="deck"> –ö–æ–ª–æ–¥–∞</label><br>
        <label><input type="checkbox" value="discard"> Discard</label><br>
        <label><input type="checkbox" value="trash"> Trash</label><br>
        <label><input type="checkbox" value="market"> –†—ã–Ω–æ–∫</label><br>
        <label><input type="checkbox" value="player"> –ò–≥—Ä–æ–∫</label><br>
        <label><input type="checkbox" value="error"> –û—à–∏–±–∫–∏</label><br>
        <label><input type="checkbox" value="all_effects"> –í—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∫–∞—Ä—Ç</label><br>
      </div>
      <button type="button" id="log-modal-select-all" style="margin-right:8px;">–í–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
      <button type="button" id="log-modal-deselect-all" style="margin-right:8px;">–í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
      <button type="button" id="save-log-config" style="background:#1976d2; color:#fff;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>
  <!-- Bootstrap bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>